# main.R
source("header.R")

  ### UI ###
ui <- dashboardPage(
  title = "MetaShARK",
  dashboardHeader(
    title = span(imageOutput("logo", inline = TRUE), "MetaShARK"),
    titleWidth = menuWidth
  ),
  ## Menus ##
  dashboardSidebar(
    useShinyjs(), 
    sidebarMenu(
      menuItem("Welcome", tabName = "welcome", 
               icon = icon("home")),
      menuItem("Fill in EML", tabName = "fill", 
               icon = icon("file-import")),
      menuItem("EML Documentation", tabName = "documentation", 
               icon = icon("glasses")),
      menuItem("About MetaShARK", tabName = "about", 
               icon = icon("beer"))
      ),
  width = menuWidth
  ),
  ## Content ##
  dashboardBody(
    tabItems(
      tabItem(tabName = "welcome",
              welcomeUI(IM.welcome[1], IM = IM.welcome)),
      tabItem(tabName = "fill",
              fillUI(IM.fill[1], IM = IM.fill)),
      tabItem(tabName = "documentation",
              docUI(IM.doc[1], IM = IM.doc)),
      tabItem(tabName = "about",
              aboutUI(IM.about[1], IM = IM.about))
    )
  )
)



### SERVER ###
server <- function(input,output,session){
  session$onSessionEnded(stopApp)
  
  ## EMLAL navigation ----
  rvNav <- reactiveValues(
    # global: possible modes for "move"
    POSSIBLE = factor(c("next","prev","quit")),
    current = 1,
    lastMove = NULL
  )
  
  observe({
    lapply(ls(pattern = "^fill.emlal.+"), function(x) {
      observe({
        x$navigate$move
        if(!is.null(x$navigate$move
                    && x$navigate$move %in% rvNav$POSSIBLE))
        {
          rvNav$lastMove <- x$navigate # last modified
          rvNav$current <- switch(rvNav$lastMove,
                                  `next`= rvNav$current+1,
                                  prev = rvNav$current-1,
                                  quit = 1)
        }
        else{
          warning("Bad value for navigation sent from part",
                  rvNav$current,"of the EMLAL module.")
        }
      })
    })
  })
  
  ## modules called ----
  # welcome
  welcome <- callModule(welcome, IM.welcome[1], IM = IM.welcome)
  # fill
  fill <- callModule(fill, 
                     IM.fill[1], 
                     IM = IM.fill)
    fill.emlal <- callModule(EMLAL, 
                             IM.EMLAL[1], 
                             IM = IM.EMLAL,
                             nav = rvNav)
      fill.emlal.selectDP <- callModule(selectDP, 
                                        IM.EMLAL[3], 
                                        IM = IM.EMLAL, 
                                        DP.path = DP.path)
      fill.emlal.createDP <- callModule(createDP, 
                                        IM.EMLAL[4], 
                                        IM = IM.EMLAL,
                                        previous = fill.emlal.selectDP)
  # doc
  doc <- callModule(documentation, 
                    IM.doc[1], 
                    IM = IM.doc)
  
  ## Common UI elements ----
  output$logo <- renderImage({list(src="resources/pictures/MetaShARK_icon2.png",
                                    contentType = "image/png",
                                    width = "100px",
                                    height = "50px") },
                             deleteFile = FALSE)
}

### APP LAUNCH ###
shinyApp(ui, server)

